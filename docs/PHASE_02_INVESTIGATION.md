# Phase 2: 調査 (Investigation)

## 目的

外部依存の制約を明確にし、ハルシネーションを防止する。

## なぜ必要か

### 外部依存は最もハルシネーションが起こりやすい

- API仕様、ライブラリの制約を想像で書く → 実装時に動かない
- 古い情報を参照 → 非推奨機能を使ってしまう
- マイナーなAPIは制約が多いため、徹底的に文章化が必要

### 制約を知らないと後で作り直しになる

- レート制限を知らずに設計 → 本番で503エラー頻発
- 認証方式を理解せずに実装 → セキュリティホール
- バージョン互換性を確認せず → 本番環境で動かない

### 1→2では副作用分析が最重要

- 変更が他に影響する箇所を見落とす → バグ発生
- 前回の設計意図を理解せず変更 → 別の機能が壊れる
- データマイグレーションを見落とす → データ不整合

## 何をするか

### 0→1の場合

#### 1. 外部依存を先に調査

- 使用予定のAPI、ライブラリ、フレームワーク
- 公式ドキュメントを徹底的に読む
- ハルシネーションが一番起こる場所を潰す

#### 2. APIドキュメントを文章化

- マイナーなAPIは特に詳細に
- 制約、レート制限、認証方法、エラーケース
- バージョン情報、互換性
- サンプルコードの動作確認

#### 3. 技術的制約を洗い出す

- バージョン互換性
- パフォーマンス制約
- セキュリティ要件
- ライセンス制約

### 1→2の場合（追加項目）

#### 1. 変更地点を特定

- どのファイル、どの関数が影響を受けるか
- データフローを追跡
- 依存関係を洗い出す

#### 2. 前回設計を参照

- なぜその設計にしたのか
- どんな制約があったのか
- ADR（Architecture Decision Records）を確認
- 前回の詳細設計をコンテキストに含める

#### 3. 副作用を徹底分析

- 変更による影響範囲
- 破壊的変更の有無
- データマイグレーション必要性
- 既存テストが壊れないか
- パフォーマンスへの影響

## チェックリスト

### 完了基準（0→1共通）

- [ ] 公式ドキュメントを確認したか？
- [ ] 技術的制約を文書化したか？
- [ ] マイナーなAPIは特に詳細に調査したか？

### 完了基準（1→2追加）

- [ ] 変更地点を特定したか？
- [ ] 前回設計のADRを確認したか？
- [ ] 副作用分析を行ったか？

### 出力物

- 調査レポート（API仕様、制約事項）
- 技術的制約リスト
- （1→2の場合）変更地点マップ
- （1→2の場合）副作用分析レポート

## 次のフェーズへの移行条件

- チェックリストの全項目が完了している
- 外部依存の制約が明確になっている
- （1→2の場合）変更影響範囲が把握できている

## 参考リソース

- API公式ドキュメント
- ライブラリのREADME/CHANGELOG
- 既存のADRドキュメント
